\chapter{Monitoring \hideme{ Andrew McNab, Steve Timm, Raja Nandakumar, Jon Hays}}
\label{ch:mon}

% Create Parameter Values - most #'s will need to be handled this way
% Preface parameter name with the chapter tag
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\FPset{MonEtfOpsPeople}{3.1} % FTE
\FPset{MonEtfDevPeople}{1.0} % FTE
\FPadd\MonEtfTotalPeople\MonEtfOpsPeople\MonEtfDevPeople %FTE

This section concerns the monitoring of services and resources on the grid. The actual monitoring of the jobs that are submitted by DUNE (WMS monitoring) is covered elsewhere. As the workflows are broadly similar to current LHC experiment workflows, DUNE plans to reuse the relevant monitoring tools (ETF, perfSonar) developed for this by WLCG which we cover in this section.

Going forward, DUNE plans to be agile and keep up with upcoming developments in this field. If there is a paradigm change in the resources made available, there may be a need to develop new tools to keep on top of the available resources and display them in a transparent manner. An example can be the widespread deployment of ipv6\cite{bib:ipv6TaskForce} networking requiring possible re-evaluation of various tools for computing. The ETF and perfSonar tools are already ipv6 compatible and can be deployed to test resources offering ipv6 connectivity in either pure or dual-stack mode.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Tools}
% \begin{dunetable}
% [Monitoring Assumptions]
% {l r l}
% {tab:mon:assumptions}
% {Assumptions for Monitoring}
% Parameter&Value&Comment\\
% ETF personnel&\etfPeople&no comment\\
% \end{dunetable}
\label{sec:mon:xyz}  %% fix label according to section
\subsection{ETF}

DUNE jobs run on all sites on the grid. Checking on the status of these jobs is a one way of keeping an eye on whether a given site / resource is functioning normally. Given that any issues can and usually do have multiple sources, it is essential to have an independent resource monitoring system to keep an eye on what is happening to help catch issues quickly. The framework that is being successfully used for this already in the WLCG is the ETF system.

ETF is the WLCG Experiments Tests Framework\cite{bib:ETFDoc},\cite{bib:ETFStatus}. This is a system of tools which regularly test all the available resources for different VOs. This has been developed and run on behalf of the WLCG experiments (VOs) for well over a decade now. This framework supports each VO running tests customized to the application and systems required by the VOs to enable a true picture (availability, reliability) of the resources available for the VO. The ETF tests run hourly and feed into the MONIT framework which keeps history information and the most recent test logs for enabling debugging and metric measurement.

The ETF framework currently involves 
\begin{enumerate}
\item High-level functional testing of about 90 hosts defined in the glide-in WMS configuraton.
\item Dashboard (checkmk) to show results.
\item Plugins conforming to Nagios standard.
\end{enumerate}

The framework has been named differently over the years keeping the underlying framework the same. With WLCG based at CERN as it is aimed for the LHC VOs, CERN currently plans to support this framework for as long as LHC exists as there will always be a need for availability and reliability metrics from an independent source.

Some customization of the tests has been done with further changes being planned among which are :
\begin{enumerate}
    \item Minimal simulation to test that a simulation works on the worker nodes
    \item Lightweight test of access to rucio servers from the worker node
\end{enumerate}

Beyond this, DUNE specific development will be required from time to time in keeping with updates to the framework both from the ETF / MONIT and from the DUNE software ends. Depending on the requirements we estimate  with 1 FTE staff effort will be needed.

It is expected X virtual machines with minimum spec Y will be required to run the service, which can be located at any site (eg CERN).

It is expected another 3 FTE will be required to monitor the ETF results, probably as part of more general computing shifts. This will involve looking at the test results, following failing tests and opening tickets for failing resources. Site administrators can also use ETF tests to understand the performance of their sites and it can be used (as it is for the LHC VOs) to provide a measure of site performance (availability, reliability).

See table X for a summary... 

\subsection{PerfSonar}

The core part of DUNE (as with LHC experiments) is to distribute the data taken at the detectors to the different resource centres for analysis. This depends on high-performance networking between the sites providing storage. From experience, identifying and solving issues needs detailed debugging tools. The WLCG solution for this is to develop and deploy a pervasive network monitoring infrastructure to identify and debug issues when they occur.

The perfSonar toolkit is an open source toolkit which has been collaboratively developed by multiple groups in Europe and the Americas. This toolkit is installed on dedicated hardware (perfSonar boxes) at all the sites providing resources to avoid contamination of network metrics with other issues. The data from these perfSonar boxes is aggregated to see the connectivity in various (kibana, grafana, checkmk, ...) ways, enumerated below.

\begin{enumerate}
    \item \url{https://psetf.opensciencegrid.org/etf/check_mk/index.py}
    \item \url{https://toolkitinfo.opensciencegrid.org/}
    \item \url{https://monit-grafana-open.cern.ch/}
    \item \url{https://atlas-kibana.mwt2.org/s/networking/app/dashboards}
    \item \url{https://perfsonar.uc.ssl-hep.org/}
    \item \url{https://sand-ci.org}
\end{enumerate}

These tools are currently well supported within WLCG with wide expertise being shared between administrators in various regular meetings and conferences. Given the expectation that networking is a core need for WLCG, it is anticipated that perfSonar as a network monitoring and debugging tool will continue to be supported into the future.

See table X for a summary... 

% \section{Summary of Assumptions and Resources}
% \subsection{Assumptions}

% ETF support assumption reference

% \subsection{Development needs}

% ETF dev effort, N FTE

% \subsection{Compute resource needs}

% ETF resource requirements list

% \subsection{Operations needs}

% ETF ops effort, M FTE



\section{Summary of Assumptions and Resource Requirements}

% This section needs summary tables at the end which will be rolled up for the full document
% Please replace #'s in the text with defined parameters and use those in the table (and teXt)
% Place your parameters at the top of the section. 
%


\begin{dunetable}
[Monitoring Assumptions]%{}
{llrlll}
{tab:mon:assumptions}
{Assumptions for Monitoring}
System&Parameter&Value&Units&Comment\\
FD & Cosmic rate & 5000 & per day&\\
%ETF personnel&\etfOpsPeople&no comment\\
\end{dunetable}




\begin{dunetable}
[Resource Requirements for Monitoring]
{llrlll}
{mon:ops:needs}
{Resource Requirements for Monitoring}
  System & Resource & Value & Units & Timeline&  Comment\\ \toprowrule   
  ETF Operations & Personnel &\MonEtfOpsPeople  & FTE & 2027-2040&\\ %\colhline % mon-ops-ETF
 ETF Development  & Personnel &\MonEtfDevPeople  & FTE & 2021-2025& \\ %\colhline % mon-dev-ETF
 ETF Total  & Personnel &\num[round-mode=places,round-precision=1]{\MonEtfTotalPeople}  & FTE & 2021-2025& \\ %\colhline % mon-tot-ETF
      & Storage  &3  & GB&2021-2040& \\ 
      \colhline % Start new section
  PerfSonar & Operations &0.1 & FTE &\\ \colhline % mon-ops-PerSonar
  Row 3 & \daqsamplerate & \\ 
\end{dunetable}